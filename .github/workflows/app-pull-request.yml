name: Build Test

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - staging
      - main
    paths:
      - "packages/app/**"
      - "yarn.lock"
      - ".github/workflows/app-*.yml"

defaults:
  run:
    working-directory: packages/app

jobs:
  deploy:
    name: Test Build for App Service
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        working-directory: ${{ github.workspace }}
        env:
          ECR_REPOSITORY: test/app-service
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build \
            --build-arg INFURA_API_KEY=12345678 \
            --build-arg WALLETCONNECT_PROJECT_ID=12345678 \
            --build-arg ENABLE_TESTNETS=1 \
            --build-arg ENABLE_HARDHAT_NODE=1 \
            -f packages/app/Dockerfile -t $ECR_REPOSITORY:$IMAGE_TAG .
